name: Build

on: workflow_dispatch

env:
  BUILD_TYPE: Release

jobs:
  build-linux:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - uses: lukka/get-cmake@latest

    - name: Install Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: '6.7.2'
        host: 'linux'
        target: 'desktop'
        arch: 'linux_gcc_64'
    
    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11

    - name: Run CMake with vcpkg.json manifest
      uses: lukka/run-cmake@v10
      with:
        configurePreset: cfg
        buildPreset: bld
        buildPresetAdditionalArgs: "['--config Release']"

    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: "guu-linux"
        path: "${{github.workspace}}/build/src/Release"

  build-windows:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v3

    - uses: lukka/get-cmake@latest

    - name: Install Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: '6.7.2'
        host: 'windows'
        target: 'desktop'
        arch: 'win64_msvc2019_64'
        dir: '${{github.workspace}}\qt\'

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11

    - name: Run CMake with vcpkg.json manifest
      uses: lukka/run-cmake@v10
      with:
        configurePreset: cfg
        buildPreset: bld
        buildPresetAdditionalArgs: "['--config Release']"

    - name: Run windeployqt
      run: |
        mkdir "${{github.workspace}}\out"
        cp "${{github.workspace}}\build\src\Release\*" "${{github.workspace}}\out"
        cd ${{github.workspace}}\out
        ${{github.workspace}}\qt\Qt\6.7.2\msvc2019_64\bin\windeployqt.exe "${{github.workspace}}\out\guu-cpp.exe" --release

    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: "guu-windows"
        path: '${{github.workspace}}\out'

  build-mac:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v3

    - uses: lukka/get-cmake@latest

    - name: Install Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: '6.7.2'
        host: 'mac'
        target: 'desktop'
        arch: 'clang_64'
    
    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11

    - name: Run CMake with vcpkg.json manifest
      uses: lukka/run-cmake@v10
      with:
        configurePreset: cfg
        buildPreset: bld
        buildPresetAdditionalArgs: "['--config Release']"

    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: "guu-mac"
        path: "${{github.workspace}}/build/src/Release"